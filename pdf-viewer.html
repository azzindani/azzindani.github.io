<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="PDF Presentation Viewer - Azzindani Portfolio">
    <title>PDF Viewer - Azzindani Portfolio</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body class="pdf-viewer-body">

    <!-- Header -->
    <header class="pdf-header">
        <a href="/" class="pdf-header-link" aria-label="Back to portfolio">
            ‚Üê Portfolio
        </a>
        <span class="pdf-header-title" id="pdf-filename">Loading PDF...</span>
        <a id="pdf-download-link" href="#" download class="pdf-header-link" aria-label="Download PDF">
            ‚Üì Download
        </a>
    </header>

    <!-- Main viewer -->
    <main class="pdf-viewer-main" id="pdf-viewer-main">

        <!-- Loading state -->
        <div id="pdf-loading" class="pdf-loading">
            <div class="loading-spinner"></div>
            <p style="color:rgba(255,255,255,0.7); margin-top:1rem;">Loading PDF presentation...</p>
        </div>

        <!-- Error state -->
        <div id="pdf-error" class="pdf-error" style="display:none;">
            <p style="font-size:3rem; margin-bottom:1rem;">üìÑ</p>
            <p id="pdf-error-msg">Could not load the PDF. Please check the file path.</p>
            <a href="/" class="btn btn-primary" style="margin-top:1.5rem; display:inline-flex;">‚Üê Back to Portfolio</a>
        </div>

        <!-- Viewer content -->
        <div id="pdf-viewer-content" style="display:none; width:100%; max-width:900px;">
            <div class="pdf-canvas-container">
                <button class="pdf-nav-btn pdf-nav-prev" id="prev-btn" disabled aria-label="Previous slide">&#8592;</button>
                <canvas id="pdf-canvas" role="img" aria-label="PDF slide"></canvas>
                <button class="pdf-nav-btn pdf-nav-next" id="next-btn" disabled aria-label="Next slide">&#8594;</button>
            </div>

            <div class="pdf-controls">
                <span class="pdf-page-counter" id="page-counter" aria-live="polite">Slide 1 of 1</span>
            </div>
        </div>
    </main>

    <!-- Thumbnail strip -->
    <div class="pdf-thumbnails" id="pdf-thumbnails" style="display:none;" role="list" aria-label="PDF slide thumbnails"></div>

    <!-- PDF.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc =
            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // State
        let pdfDoc = null;
        let currentPage = 1;
        let totalPages = 0;
        let isRendering = false;
        let renderPending = false;
        let thumbnailCanvases = [];

        // DOM elements
        const mainCanvas = document.getElementById('pdf-canvas');
        const ctx = mainCanvas.getContext('2d');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const pageCounter = document.getElementById('page-counter');
        const thumbnailStrip = document.getElementById('pdf-thumbnails');
        const loadingEl = document.getElementById('pdf-loading');
        const errorEl = document.getElementById('pdf-error');
        const errorMsg = document.getElementById('pdf-error-msg');
        const viewerContent = document.getElementById('pdf-viewer-content');

        // Get file path from URL query param
        function getPdfPath() {
            const params = new URLSearchParams(window.location.search);
            return params.get('file');
        }

        // Show error state
        function showError(message) {
            loadingEl.style.display = 'none';
            viewerContent.style.display = 'none';
            thumbnailStrip.style.display = 'none';
            errorMsg.textContent = message;
            errorEl.style.display = 'block';
        }

        // Compute render scale to fit container width
        function getScale(page) {
            const containerWidth = Math.min(
                document.getElementById('pdf-viewer-main').clientWidth - 120,
                860
            );
            const viewport = page.getViewport({ scale: 1 });
            return Math.max(containerWidth / viewport.width, 0.5);
        }

        // Render a page to the main canvas
        async function renderPage(pageNum) {
            if (isRendering) {
                renderPending = pageNum;
                return;
            }
            isRendering = true;
            renderPending = false;

            try {
                const page = await pdfDoc.getPage(pageNum);
                const scale = getScale(page);
                const viewport = page.getViewport({ scale });

                mainCanvas.width = viewport.width;
                mainCanvas.height = viewport.height;
                mainCanvas.setAttribute('aria-label', `Slide ${pageNum} of ${totalPages}`);

                await page.render({ canvasContext: ctx, viewport }).promise;

                // Update UI
                pageCounter.textContent = `Slide ${pageNum} of ${totalPages}`;
                prevBtn.disabled = pageNum <= 1;
                nextBtn.disabled = pageNum >= totalPages;

                // Highlight active thumbnail
                thumbnailCanvases.forEach((tc, i) => {
                    tc.parentElement.classList.toggle('active', i === pageNum - 1);
                });

                // Scroll thumbnail into view
                if (thumbnailCanvases[pageNum - 1]) {
                    thumbnailCanvases[pageNum - 1].parentElement.scrollIntoView({
                        behavior: 'smooth',
                        inline: 'center',
                        block: 'nearest'
                    });
                }
            } catch (err) {
                console.error('Render error:', err);
            }

            isRendering = false;

            // Handle pending render request
            if (renderPending !== false) {
                const pending = renderPending;
                renderPending = false;
                renderPage(pending);
            }
        }

        // Render a thumbnail for a page
        async function renderThumbnail(pageNum) {
            try {
                const page = await pdfDoc.getPage(pageNum);
                const viewport = page.getViewport({ scale: 0.18 });

                const wrapper = document.createElement('div');
                wrapper.className = 'pdf-thumbnail';
                wrapper.setAttribute('role', 'listitem');
                wrapper.setAttribute('aria-label', `Go to slide ${pageNum}`);
                wrapper.setAttribute('tabindex', '0');
                wrapper.addEventListener('click', () => goToPage(pageNum));
                wrapper.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        goToPage(pageNum);
                    }
                });

                const thumbCanvas = document.createElement('canvas');
                thumbCanvas.width = viewport.width;
                thumbCanvas.height = viewport.height;

                await page.render({
                    canvasContext: thumbCanvas.getContext('2d'),
                    viewport
                }).promise;

                wrapper.appendChild(thumbCanvas);
                thumbnailStrip.appendChild(wrapper);
                thumbnailCanvases.push(thumbCanvas);
            } catch (err) {
                console.warn(`Thumbnail render error for page ${pageNum}:`, err);
            }
        }

        // Navigation helpers
        function goToPage(num) {
            if (!pdfDoc || num < 1 || num > totalPages) return;
            currentPage = num;
            renderPage(currentPage);
        }

        prevBtn.addEventListener('click', () => goToPage(currentPage - 1));
        nextBtn.addEventListener('click', () => goToPage(currentPage + 1));

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'ArrowUp' || e.key === 'PageUp') {
                e.preventDefault();
                goToPage(currentPage - 1);
            } else if (e.key === 'ArrowRight' || e.key === 'ArrowDown' || e.key === 'PageDown') {
                e.preventDefault();
                goToPage(currentPage + 1);
            } else if (e.key === 'Home') {
                goToPage(1);
            } else if (e.key === 'End') {
                goToPage(totalPages);
            }
        });

        // Touch / swipe support
        let touchStartX = 0;
        let touchStartY = 0;
        mainCanvas.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        }, { passive: true });

        mainCanvas.addEventListener('touchend', (e) => {
            const dx = touchStartX - e.changedTouches[0].clientX;
            const dy = Math.abs(touchStartY - e.changedTouches[0].clientY);
            if (Math.abs(dx) > 50 && dy < 60) {
                dx > 0 ? goToPage(currentPage + 1) : goToPage(currentPage - 1);
            }
        }, { passive: true });

        // Responsive re-render on resize
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                if (pdfDoc) renderPage(currentPage);
            }, 250);
        });

        // Main init
        async function init() {
            const filePath = getPdfPath();

            if (!filePath) {
                showError('No PDF file specified. Use ?file=path/to/presentation.pdf');
                return;
            }

            // Update page title and header
            const filename = decodeURIComponent(filePath).split('/').pop();
            document.title = `${filename} ‚Äî Azzindani Portfolio`;
            document.getElementById('pdf-filename').textContent = filename;
            document.getElementById('pdf-download-link').href = filePath;
            document.getElementById('pdf-download-link').setAttribute('download', filename);

            try {
                pdfDoc = await pdfjsLib.getDocument(filePath).promise;
                totalPages = pdfDoc.numPages;

                // Show viewer
                loadingEl.style.display = 'none';
                viewerContent.style.display = 'block';

                // Show thumbnail strip only for multi-page PDFs
                if (totalPages > 1) {
                    thumbnailStrip.style.display = 'flex';
                    nextBtn.disabled = false;
                }

                // Render first page immediately
                await renderPage(1);

                // Render thumbnails progressively in the background
                for (let i = 1; i <= totalPages; i++) {
                    await renderThumbnail(i);
                    // Mark first thumbnail active after it renders
                    if (i === 1 && thumbnailCanvases.length > 0) {
                        thumbnailCanvases[0].parentElement.classList.add('active');
                    }
                }

            } catch (err) {
                console.error('PDF load error:', err);
                if (err.name === 'InvalidPDFException') {
                    showError('The file does not appear to be a valid PDF.');
                } else if (err.message && err.message.includes('404')) {
                    showError(`PDF not found: ${filename}. Please check the file has been uploaded to the repository.`);
                } else {
                    showError(`Could not load PDF: ${err.message || 'Unknown error'}`);
                }
            }
        }

        init();
    </script>
</body>
</html>
